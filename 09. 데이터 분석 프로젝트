ğŸ“ KOWEPS ë°ì´í„° ë¶„ì„ ì‹¤ìŠµ
1. ë¶„ì„ ì¤€ë¹„
# íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ì²˜ìŒ í•œ ë²ˆë§Œ)
# pip install pyreadstat openpyxl

# íŒ¨í‚¤ì§€ ë¡œë“œ
import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt

plt.rcParams.update({'font.family': 'Malgun Gothic'})  # í•œê¸€ í°íŠ¸ ì„¤ì •

2. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° ë³µì‚¬
raw_welfare = pd.read_spss("Koweps_hpwc14_2019_beta2.sav")
welfare = raw_welfare.copy()

3. ë°ì´í„° ê²€í† 
welfare.shape        # (í–‰, ì—´)
welfare.info()       # ë³€ìˆ˜ íƒ€ì…
welfare.describe()   # ìš”ì•½ í†µê³„ëŸ‰

4. ë³€ìˆ˜ëª… ë³€ê²½
welfare = welfare.rename(columns={
    'h14_g3': 'sex',
    'h14_g4': 'birth',
    'h14_g10': 'religion',
    'h14_g11': 'marriage_type',
    'p1402_8aq1': 'income',
    'h14_eco9': 'code_job',
    'h14_reg7': 'code_region'
})

âœ… ì„±ë³„ì— ë”°ë¥¸ ì›”ê¸‰ ì°¨ì´
# ì „ì²˜ë¦¬
welfare['sex'] = np.where(welfare['sex'] == 9, np.nan, welfare['sex'])
welfare['sex'] = np.where(welfare['sex'] == 1, 'male', 'female')

welfare['income'] = np.where(welfare['income'] == 9999, np.nan, welfare['income'])

# ë¶„ì„
sex_income = welfare.dropna(subset=['income']) \
                    .groupby('sex', as_index=False) \
                    .agg(mean_income=('income', 'mean'))

sns.barplot(data=sex_income, x='sex', y='mean_income')

âœ… ë‚˜ì´ì™€ ì›”ê¸‰ ê´€ê³„
welfare['birth'] = np.where(welfare['birth'] == 9999, np.nan, welfare['birth'])
welfare = welfare.assign(age=2019 - welfare['birth'] + 1)

age_income = welfare.dropna(subset=['income']) \
                    .groupby('age') \
                    .agg(mean_income=('income', 'mean'))

sns.lineplot(data=age_income, x='age', y='mean_income')

âœ… ì—°ë ¹ëŒ€ë³„ ì›”ê¸‰ ì°¨ì´
welfare = welfare.assign(
    ageg=np.where(welfare['age'] < 30, 'young',
           np.where(welfare['age'] <= 59, 'middle', 'old'))
)

ageg_income = welfare.dropna(subset=['income']) \
                     .groupby('ageg', as_index=False) \
                     .agg(mean_income=('income', 'mean'))

sns.barplot(data=ageg_income, x='ageg', y='mean_income', order=['young', 'middle', 'old'])

âœ… ì—°ë ¹ëŒ€ + ì„±ë³„ ì›”ê¸‰ ì°¨ì´
sex_income = welfare.dropna(subset=['income']) \
                    .groupby(['ageg', 'sex'], as_index=False) \
                    .agg(mean_income=('income', 'mean'))

sns.barplot(data=sex_income, x='ageg', y='mean_income', hue='sex', order=['young', 'middle', 'old'])

âœ… ë‚˜ì´ + ì„±ë³„ ì›”ê¸‰ ì¶”ì„¸
sex_age = welfare.dropna(subset=['income']) \
                 .groupby(['age', 'sex'], as_index=False) \
                 .agg(mean_income=('income', 'mean'))

sns.lineplot(data=sex_age, x='age', y='mean_income', hue='sex')

âœ… ì§ì—…ë³„ ì›”ê¸‰ ì°¨ì´
list_job = pd.read_excel("Koweps_Codebook.xlsx", sheet_name='ì§ì¢…ì½”ë“œ')
welfare = welfare.merge(list_job, how='left', on='code_job')

job_income = welfare.dropna(subset=['job', 'income']) \
                    .groupby('job', as_index=False) \
                    .agg(mean_income=('income', 'mean'))

# ìƒìœ„ 10ê°œ
top10 = job_income.sort_values('mean_income', ascending=False).head(10)
sns.barplot(data=top10, y='job', x='mean_income')

# í•˜ìœ„ 10ê°œ
bottom10 = job_income.sort_values('mean_income').head(10)
sns.barplot(data=bottom10, y='job', x='mean_income').set(xlim=[0, 800])

âœ… ì„±ë³„ ì§ì—… ë¹ˆë„
job_male = welfare.dropna(subset=['job']) \
                  .query('sex == "male"') \
                  .groupby('job', as_index=False) \
                  .agg(n=('job', 'count')) \
                  .sort_values('n', ascending=False) \
                  .head(10)

job_female = welfare.dropna(subset=['job']) \
                    .query('sex == "female"') \
                    .groupby('job', as_index=False) \
                    .agg(n=('job', 'count')) \
                    .sort_values('n', ascending=False) \
                    .head(10)

sns.barplot(data=job_male, y='job', x='n').set(xlim=[0, 500])
sns.barplot(data=job_female, y='job', x='n').set(xlim=[0, 500])

âœ… ì¢…êµ ìœ ë¬´ì— ë”°ë¥¸ ì´í˜¼ìœ¨
welfare['religion'] = np.where(welfare['religion'] == 1, 'yes', 'no')

welfare['marriage'] = np.where(welfare['marriage_type'] == 1, 'marriage',
                        np.where(welfare['marriage_type'] == 3, 'divorce', 'etc'))

rel_div = welfare.query('marriage != "etc"') \
                 .groupby('religion', as_index=False)['marriage'] \
                 .value_counts(normalize=True)

rel_div = rel_div.query('marriage == "divorce"') \
                 .assign(proportion=rel_div['proportion'] * 100) \
                 .round(1)

sns.barplot(data=rel_div, x='religion', y='proportion')

âœ… ì—°ë ¹ëŒ€ + ì¢…êµì— ë”°ë¥¸ ì´í˜¼ìœ¨
age_rel_div = welfare.query('marriage != "etc" & ageg != "young"') \
                     .groupby(['ageg', 'religion'], as_index=False)['marriage'] \
                     .value_counts(normalize=True)

age_rel_div = age_rel_div.query('marriage == "divorce"') \
                         .assign(proportion=age_rel_div['proportion'] * 100) \
                         .round(1)

sns.barplot(data=age_rel_div, x='ageg', y='proportion', hue='religion')

âœ… ì§€ì—­ë³„ ì—°ë ¹ëŒ€ ë¹„ìœ¨
list_region = pd.DataFrame({
    'code_region': [1,2,3,4,5,6,7],
    'region': ['ì„œìš¸', 'ìˆ˜ë„ê¶Œ', 'ë¶€ì‚°/ê²½ë‚¨/ìš¸ì‚°', 'ëŒ€êµ¬/ê²½ë¶', 'ëŒ€ì „/ì¶©ë‚¨', 'ê°•ì›/ì¶©ë¶', 'ê´‘ì£¼/ì „ë‚¨/ì „ë¶/ì œì£¼ë„']
})
welfare = welfare.merge(list_region, how='left', on='code_region')

region_ageg = welfare.groupby('region', as_index=False)['ageg'] \
                     .value_counts(normalize=True) \
                     .assign(proportion=lambda df: (df['proportion'] * 100).round(1))

sns.barplot(data=region_ageg, y='region', x='proportion', hue='ageg')

# ëˆ„ì  ë§‰ëŒ€ ê·¸ë˜í”„
pivot_df = region_ageg.pivot(index='region', columns='ageg', values='proportion')
pivot_df.plot.barh(stacked=True)

# ì •ë ¬
reorder_df = pivot_df.sort_values('old')[['young', 'middle', 'old']]
reorder_df.plot.barh(stacked=True)
